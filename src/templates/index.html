<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Metadata Generation Configuration</title>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>
        $(function () {
            // Setup autocomplete: the dropdown shows "Label (QID)" but on selection the input value is set to the QID.
            // The label text is shown in an adjacent span.
            function setupAutocomplete(selector) {
                $(selector).autocomplete({
                    source: function (request, response) {
                        $.ajax({
                            url: "https://www.wikidata.org/w/api.php",
                            dataType: "jsonp",
                            data: {
                                action: "wbsearchentities",
                                format: "json",
                                language: "en",
                                uselang: "en",
                                type: "item",
                                search: request.term
                            },
                            success: function (data) {
                                response($.map(data.search, function (item) {
                                    return {
                                        label: item.label + " (" + item.id + ")",
                                        labelDisplay: item.label,
                                        qid: item.id,
                                        value: item.id // input value will be just the QID
                                    };
                                }));
                            }
                        });
                    },
                    minLength: 2,
                    select: function (event, ui) {
                        // Set the input value to the QID.
                        $(this).val(ui.item.qid);
                        // Update the adjacent span with the label.
                        $("#" + this.id + "_label").text(ui.item.labelDisplay);
                        // Store the QID in a data attribute (if needed later).
                        $(this).data("qid", ui.item.qid);
                        return false;
                    }
                });
            }

            // Given a QID, fetch its label from Wikidata.
            function fetchLabelForQID(qid, callback) {
                $.ajax({
                    url: "https://www.wikidata.org/w/api.php",
                    dataType: "jsonp",
                    data: {
                        action: "wbgetentities",
                        ids: qid,
                        format: "json",
                        props: "labels",
                        languages: "en"
                    },
                    success: function (data) {
                        if (data.entities && data.entities[qid] && data.entities[qid].labels && data.entities[qid].labels.en) {
                            callback(data.entities[qid].labels.en.value);
                        } else {
                            callback(null);
                        }
                    }
                });
            }

            // On page load, if an input already holds a QID from the saved config, fetch and display its label.
            function updateFieldFromQID(selector) {
                var input = $(selector);
                var qid = input.val().trim();
                if (qid && qid.match(/^Q\d+$/)) {
                    fetchLabelForQID(qid, function (label) {
                        if (label) {
                            // Display the label in the span.
                            $("#" + input.attr("id") + "_label").text(label);
                            // Ensure the input value remains the QID.
                            input.val(qid);
                            input.data("qid", qid);
                        }
                    });
                }
            }

            // Setup autocomplete for each field.
            setupAutocomplete("#ILLUSTRATOR");
            setupAutocomplete("#ILLUSTRATOR2");
            setupAutocomplete("#PAINTER");
            setupAutocomplete("#ENGRAVER");
            setupAutocomplete("#LITHOGRAPHER");

            // On page load, update the display for fields that already have a QID.
            updateFieldFromQID("#ILLUSTRATOR");
            updateFieldFromQID("#ILLUSTRATOR2");
            updateFieldFromQID("#PAINTER");
            updateFieldFromQID("#ENGRAVER");
            updateFieldFromQID("#LITHOGRAPHER");

            // No extra submit handler is needed because the input value is already the QID.
        });

        // Shows a loading indicator when the form is submitted.
        function showLoading() {
            document.getElementById("loading").style.display = "block";
        }

        // Sets the form action and submits the form.
        function submitForm(action) {
            const form = document.getElementById("configForm");
            form.action = action;
            form.submit();
        }
    </script>
    <style>
        #loading {
            display: none;
            font-weight: bold;
            color: red;
        }

        .field-wrapper {
            display: flex;
            align-items: center;
        }

        .field-wrapper span.label-display {
            margin-left: 10px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <h1>Enter Configuration Values</h1>
    <form id="configForm" method="post" onsubmit="showLoading()">
        <label for="CATEGORY_RAW">CATEGORY_RAW:</label>
        <input type="text" id="CATEGORY_RAW" name="CATEGORY_RAW" size="80" value="{{ config.CATEGORY_RAW }}" required>
        <br><br>
        <input type="button" value="Generate Metadata" onclick="submitForm('{{ url_for('index') }}')">
        <input type="button" value="Upload Data" onclick="submitForm('{{ url_for('upload') }}')">
    </form>

    <div id="loading">Generating metadata, please wait...</div>

    {% if message %}
    <p>{{ message }}</p>
    <p>Output file: <a href="{{ url_for('download_file', filename=output_file) }}">Download {{ output_file }}</a></p>
    {% endif %}
</body>

</html>